# ğŸ”§ Dockerfile æ„å»ºé”™è¯¯ä¿®å¤è¯´æ˜

## ğŸš¨ é‡åˆ°çš„é—®é¢˜

**é”™è¯¯ç±»å‹**: pkcs11js native æ¨¡å—ç¼–è¯‘å¤±è´¥
**æ ¹æœ¬åŸå› **: åœ¨ production é˜¶æ®µç¼ºå°‘ Python å’Œç¼–è¯‘å·¥å…·

```
npm error gyp ERR! find Python Python is not set from command line or npm configuration
npm error path /backend/node_modules/pkcs11js
npm error command failed: node-gyp rebuild
```

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é”™è¯¯çš„åŸå› 

1. **Native æ¨¡å—ä¾èµ–**: `pkcs11js` æ˜¯ä¸€ä¸ªéœ€è¦ç¼–è¯‘çš„ native Node.js æ¨¡å—
2. **ç¼ºå°‘ç¼–è¯‘å·¥å…·**: åœ¨ production é˜¶æ®µç§»é™¤äº† python3 å’Œç¼–è¯‘å·¥å…·
3. **æ—¶æœºé”™è¯¯**: åœ¨ production é˜¶æ®µé‡æ–°è¿è¡Œ `npm ci` è§¦å‘äº† native æ¨¡å—ç¼–è¯‘

### é”™è¯¯çš„ä¼˜åŒ–ç­–ç•¥

```dockerfile
# âŒ é”™è¯¯åšæ³•: åœ¨productioné˜¶æ®µé‡æ–°å®‰è£…npmåŒ…
FROM node:20-slim AS production
RUN apt-get install -y ca-certificates bash curl...  # æ²¡æœ‰python3å’Œç¼–è¯‘å·¥å…·
COPY backend/package*.json ./
RUN npm ci --only-production  # è§¦å‘nativeæ¨¡å—ç¼–è¯‘ï¼Œä½†ç¼ºå°‘å·¥å…·
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ç­–ç•¥: åœ¨æ„å»ºé˜¶æ®µå®Œæˆæ‰€æœ‰ç¼–è¯‘

```dockerfile
# âœ… æ­£ç¡®åšæ³•: åœ¨æœ‰ç¼–è¯‘å·¥å…·çš„é˜¶æ®µå®Œæˆnpmå®‰è£…
FROM builder-base AS backend-builder
# åœ¨è¿™ä¸ªé˜¶æ®µæœ‰å®Œæ•´çš„ç¼–è¯‘ç¯å¢ƒ
RUN npm ci --only-production  # nativeæ¨¡å—åœ¨è¿™é‡Œç¼–è¯‘
RUN npm run build

# productioné˜¶æ®µç›´æ¥å¤åˆ¶å·²ç¼–è¯‘çš„ç»“æœ
FROM node:20-slim AS production
# ä¸éœ€è¦é‡æ–°å®‰è£…npmåŒ…ï¼Œç›´æ¥å¤åˆ¶
COPY --from=backend-builder /app .  # åŒ…å«å·²ç¼–è¯‘çš„node_modules
```

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ (æœ‰é—®é¢˜çš„æµç¨‹)

```
builder-base (æœ‰ç¼–è¯‘å·¥å…·)
  â†“
backend-builder (å®‰è£…npmåŒ…)
  â†“
production (æ— ç¼–è¯‘å·¥å…·) â†’ npm ci --only-production âŒ å¤±è´¥
```

### ä¿®å¤å (æ­£ç¡®çš„æµç¨‹)

```
builder-base (æœ‰ç¼–è¯‘å·¥å…·)
  â†“
backend-builder (å®‰è£…npmåŒ… + ç¼–è¯‘nativeæ¨¡å—) âœ… æˆåŠŸ
  â†“
production (æ— ç¼–è¯‘å·¥å…·) â†’ ç›´æ¥å¤åˆ¶å·²ç¼–è¯‘ç»“æœ âœ… æˆåŠŸ
```

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹

1. **ç¼–è¯‘æ—¶æœº**: åœ¨æœ‰ç¼–è¯‘å·¥å…·çš„`backend-builder`é˜¶æ®µå®Œæˆæ‰€æœ‰ npm å®‰è£…
2. **é¿å…é‡å¤**: production é˜¶æ®µä¸å†é‡æ–°å®‰è£… npm åŒ…
3. **ç›´æ¥å¤åˆ¶**: å¤åˆ¶å·²ç»ç¼–è¯‘å¥½çš„`node_modules`åˆ° production
4. **ä¿æŒä¼˜åŒ–**: ä»ç„¶é¿å…åœ¨ production å®‰è£…ä¸å¿…è¦çš„å·¥å…·

## ğŸ’¡ ç»éªŒæ•™è®­

### Native æ¨¡å—å¤„ç†åŸåˆ™

1. **ä¸€æ¬¡ç¼–è¯‘**: åœ¨æœ‰å®Œæ•´ç¼–è¯‘ç¯å¢ƒçš„é˜¶æ®µå®Œæˆ
2. **ç»“æœå¤ç”¨**: ç¼–è¯‘ç»“æœç›´æ¥å¤åˆ¶åˆ°è¿è¡Œç¯å¢ƒ
3. **é¿å…é‡å»º**: è¿è¡Œç¯å¢ƒä¸åº”è¯¥è§¦å‘é‡æ–°ç¼–è¯‘

### Docker ä¼˜åŒ–çš„å¹³è¡¡ç‚¹

- **ä¸èƒ½è¿‡åº¦ç²¾ç®€**: æŸäº›ä¾èµ–ç¡®å®éœ€è¦ç¼–è¯‘å·¥å…·
- **é˜¶æ®µåˆ†å·¥æ˜ç¡®**: æ„å»ºé˜¶æ®µè´Ÿè´£ç¼–è¯‘ï¼Œè¿è¡Œé˜¶æ®µè´Ÿè´£è¿è¡Œ
- **å¤åˆ¶ç­–ç•¥**: å¤åˆ¶ç»“æœè€Œä¸æ˜¯é‡æ–°æ„å»º

è¿™ä¸ªä¿®å¤ç¡®ä¿äº†é•œåƒæ—¢ä¿æŒäº†ä¼˜åŒ–æ•ˆæœï¼Œåˆè§£å†³äº† native æ¨¡å—ç¼–è¯‘é—®é¢˜ã€‚
